# GhostPost Agent Readiness Plan

> Making GhostPost bulletproof for OpenClaw consumption

**Created:** 2026-02-24 | **Status:** COMPLETE (all items implemented, pending API restart)

---

## Audit Summary

GhostPost has all the features but the agent interface layer is broken or incomplete. OpenClaw reads markdown context files as its primary interface — and those files are currently **useless**:

| Issue | Severity | Impact |
|-------|----------|--------|
| EMAIL_CONTEXT.md shows "### Single" — no thread IDs, no subjects, no senders | **CRITICAL** | Agent can't identify any thread |
| ALERTS.md polluted with `<MagicMock>` objects from test suite | **HIGH** | Agent trusts garbage data |
| No SYSTEM_BRIEF.md — agent has no single-file dashboard | **HIGH** | Agent must read 6 files to understand state |
| Context files lack sender/from info entirely | **HIGH** | Agent can't know who emailed |
| Duplicate alerts (same entry 3-6x) | **MEDIUM** | Wastes agent context window |
| No `ghostpost status` command | **MEDIUM** | Agent needs multiple commands for overview |
| No atomic writes — partial reads possible | **MEDIUM** | Corrupt context on concurrent access |
| No schema versioning on context files | **LOW** | Future format changes break agent silently |
| CLI errors are human text, not structured | **LOW** | Agent can't parse error responses |

---

## Phase A: Critical Fixes (do first)

### A1. Fix test suite leaking into production context

**Problem:** Goal tests call real `notify_goal_met()` which appends MagicMock-stringified data to `context/ALERTS.md`.

**Fix:**
- Patch `src.engine.goals.notify_goal_met` in all goal-met tests
- Add conftest fixture that patches `notifications._append_alert` globally — no test should ever write to `context/`

**Files:** `tests/test_goals.py`, `tests/conftest.py`
**Size:** S

### A2. Purge and regenerate ALERTS.md

**Problem:** 100+ lines of MagicMock garbage and duplicate entries.

**Fix:** Delete corrupted ALERTS.md, write clean header-only file. Real notifications will populate it going forward.

**Files:** `context/ALERTS.md`
**Size:** S | **Depends on:** A1

### A3. Deduplicate alerts on write

**Problem:** Follow-up checker runs repeatedly, generates identical "Stale thread" alerts.

**Fix:** In `notifications.py._append_alert()`, check last 50 entries for identical (title + thread_id + message) before appending. Skip if duplicate within 5-minute window.

**Files:** `src/engine/notifications.py`
**Size:** S

### A4. Regenerate all context files

**Problem:** EMAIL_CONTEXT.md was generated by old code — shows bare "Single" without `[#id]` prefix.

**Fix:** Run `write_all_context_files()` to regenerate from current code. Investigate if DB truly has threads with subject "Single" (likely test data).

**Files:** `src/engine/context_writer.py` (trigger only)
**Size:** S

### A5. Add sender info to EMAIL_CONTEXT.md

**Problem:** Context writer queries Thread but never shows who sent the email. Agent can't make decisions without knowing the sender.

**Fix:** Thread model has `emails` relationship (lazy="selectin"). Extract first email's `from_address`, add `- **From:** {sender}` and `- **Emails:** {count}` lines to each thread entry.

**Files:** `src/engine/context_writer.py` (function `write_email_context`)
**Size:** S

---

## Phase B: Agent Experience

### B1. Create SYSTEM_BRIEF.md — the agent's dashboard

**Problem:** Agent must read 6 files to understand system state. Best practice: one file, under 50 lines, health + snapshot + exceptions.

**Fix:** New function `write_system_brief()` in context_writer.py. Content:

```markdown
# System Brief
_Generated: 2026-02-24T10:30:00Z_

## Health
- API: UP | DB: UP | Redis: UP | Gmail Sync: OK (last: 08:15)

## Inbox
- Threads: 100 | Unread: 15 | Action Required: 3
- By state: NEW(2) ACTIVE(8) WAITING_REPLY(5) FOLLOW_UP(0) ARCHIVED(85)

## Priority Items
| # | Thread | From | Urgency | Action |
|---|--------|------|---------|--------|
| 142 | Contract review | client@co.com | HIGH | Reply needed |
| 98 | Meeting request | john@co.com | MEDIUM | Confirm time |

## Overdue Follow-ups (2)
- Thread #45: Vendor quote — 2 days overdue
- Thread #67: Partnership — 1 day overdue

## Pending (drafts: 8, goals: 0, alerts: 0)

## Recent (last 6h)
- 3 new emails received
- 1 draft created
```

Add to `write_all_context_files()`. Refresh on every sync cycle.

**Files:** `src/engine/context_writer.py`
**Size:** M

### B2. Add `ghostpost status` CLI command

**Problem:** Agent needs ONE command for full system overview.

**Fix:** New `status` command in `src/cli/system.py`. Calls `/api/health` + `/api/stats` + reads SYSTEM_BRIEF.md. Supports `--json` flag.

**Files:** `src/cli/system.py`, `src/cli/main.py`
**Size:** S

### B3. Unify ALERTS.md and SECURITY_ALERTS.md

**Problem:** Two separate alert files with different generators. ALERTS.md is append-based (notifications.py), SECURITY_ALERTS.md is regenerate-based (context_writer.py).

**Fix:** Keep append-based approach for real-time alerts. Add cleanup function in `write_all_context_files()` that deduplicates and trims ALERTS.md to last 50 entries. Document ownership split.

**Files:** `src/engine/context_writer.py`, `src/engine/notifications.py`
**Size:** M | **Depends on:** A3

---

## Phase C: Robustness

### C1. Atomic writes for all context files

**Fix:** Helper function `_atomic_write(path, content)` — writes to temp file, then `os.replace()`. Replace all `open(path, "w")` calls. Also update `_append_alert`.

**Files:** `src/engine/context_writer.py`, `src/engine/notifications.py`
**Size:** S

### C2. Add `--json` flag to all CLI commands

**Fix:** Shared Click callback/decorator. When `--json` active, output consistent envelope: `{"ok": true, "data": {...}}` or `{"ok": false, "error": "...", "code": "...", "retryable": true/false}`.

**Files:** `src/cli/api_client.py`, all CLI modules
**Size:** M

### C3. Structured error handling in CLI

**Fix:** When `--json` active, errors output JSON instead of human text + sys.exit.

**Files:** `src/cli/api_client.py`
**Size:** S | **Depends on:** C2

### C4. Schema versioning for context files

**Fix:** Add `<!-- schema_version: 1 -->` as second line of every context file. Create `context/SCHEMA.md` documenting the format contract.

**Files:** `src/engine/context_writer.py`
**Size:** S

---

## Execution Order

```
Parallel batch 1 (no dependencies):
  A1 + A4 + A5 + B1 + B2 + C1 + C4

Sequential after A1:
  A2 (purge alerts)

Sequential after A3:
  B3 (unify alerts)

Sequential:
  C2 → C3 (JSON flag → error handling)

Final:
  A4 again (regenerate all context files with all fixes applied)
```

---

## Definition of Done

- [ ] EMAIL_CONTEXT.md shows: thread IDs, real subjects, sender email, email count
- [ ] ALERTS.md has zero MagicMock entries, no duplicates
- [ ] `context/SYSTEM_BRIEF.md` exists, under 50 lines, auto-refreshes
- [ ] `ghostpost status` works with `--json` support
- [ ] All context writes are atomic (temp + rename)
- [ ] Schema version present in all context files
- [ ] Tests cannot write to production `context/` directory
- [ ] All 344+ tests still pass
